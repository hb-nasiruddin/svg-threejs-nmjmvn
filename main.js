import * as THREE from '~three';
import { OrbitControls } from '~three/examples/jsm/controls/OrbitControls.js';
import { SVGLoader } from '~three/examples/jsm/loaders/SVGLoader.js';
import { BendModifier } from '~three/examples/jsm/modifiers/BendModifier.js';

// svg.js
const fillMaterial = new THREE.MeshBasicMaterial({
  color: 'rgb(169,169,169)',
  side: THREE.DoubleSide,
});
const strokeMaterial = new THREE.LineBasicMaterial({
  color: 'rgb(0,0,0)',
});
const renderSVG = (extrusion, svg) => {
  const loader = new SVGLoader();
  const svgData = loader.parse(svg);
  const svgGroup = new THREE.Group();
  const updateMap = [];
  console.log('svgData shapes', svgData.paths);
  // console.log('svgData', svgData);
  svgGroup.scale.y *= -1;
  svgData.paths.forEach((path) => {
    const shapes = SVGLoader.createShapes(path);

    shapes.forEach((shape) => {
      const meshGeometry = new THREE.ExtrudeBufferGeometry(shape, {
        depth: extrusion,
        bevelEnabled: false,
      });
      const linesGeometry = new THREE.EdgesGeometry(meshGeometry);
      const mesh = new THREE.Mesh(meshGeometry, fillMaterial);
      const lines = new THREE.LineSegments(linesGeometry, strokeMaterial);

      updateMap.push({ shape, mesh, lines });
      svgGroup.add(mesh, lines);
    });
  });

  const box = new THREE.Box3().setFromObject(svgGroup);
  const size = box.getSize(new THREE.Vector3());
  const yOffset = size.y / -2;
  const xOffset = size.x / -2;

  // Offset all of group's elements, to center them
  svgGroup.children.forEach((item) => {
    item.position.x = xOffset;
    item.position.y = yOffset;
  });
  svgGroup.rotateX(-Math.PI / 2);

  return {
    object: svgGroup,
    update(extrusion) {
      updateMap.forEach((updateDetails) => {
        const meshGeometry = new THREE.ExtrudeBufferGeometry(
          updateDetails.shape,
          {
            depth: extrusion,
            bevelEnabled: false,
          }
        );
        const linesGeometry = new THREE.EdgesGeometry(meshGeometry);

        updateDetails.mesh.geometry.dispose();
        updateDetails.lines.geometry.dispose();
        updateDetails.mesh.geometry = meshGeometry;
        updateDetails.lines.geometry = linesGeometry;
      });
    },
  };
};

// Utility function to get the bounds of a subPath
const getSubPathBounds = (subPath) => {
  const bounds = {
    minX: Infinity,
    minY: Infinity,
    maxX: -Infinity,
    maxY: -Infinity,
  };

  subPath.curves.forEach((curve) => {
    const { x: x1, y: y1 } = curve.v1;
    const { x: x2, y: y2 } = curve.v2;

    bounds.minX = Math.min(bounds.minX, x1, x2);
    bounds.minY = Math.min(bounds.minY, y1, y2);
    bounds.maxX = Math.max(bounds.maxX, x1, x2);
    bounds.maxY = Math.max(bounds.maxY, y1, y2);
  });

  return bounds;
};

// scene.js
const setupScene = (container) => {
  const scene = new THREE.Scene();
  const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
  const camera = new THREE.PerspectiveCamera(
    50,
    window.innerWidth / window.innerHeight,
    0.01,
    1e5
  );
  const ambientLight = new THREE.AmbientLight('#888888');
  const pointLight = new THREE.PointLight('#ffffff', 2, 800);
  const controls = new OrbitControls(camera, renderer.domElement);
  const animate = () => {
    renderer.render(scene, camera);
    controls.update();

    requestAnimationFrame(animate);
  };

  renderer.setSize(window.innerWidth, window.innerHeight);
  scene.add(ambientLight, pointLight);
  camera.position.z = 50;
  camera.position.x = 50;
  camera.position.y = 50;
  controls.enablePan = false;

  container.append(renderer.domElement);
  window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });
  animate();

  return scene;
};
// svg.js
const svg_ai = `<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg
   xmlns:dc="http://purl.org/dc/elements/1.1/"
   xmlns:cc="http://creativecommons.org/ns#"
   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
   xmlns:svg="http://www.w3.org/2000/svg"
   xmlns="http://www.w3.org/2000/svg"
   viewBox="0 0 576.68268 384.68134"
   height="384.68134"
   width="576.68268"
   xml:space="preserve"
   id="svg2"
   version="1.1"><metadata
     id="metadata8"><rdf:RDF><cc:Work
         rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type
           rdf:resource="http://purl.org/dc/dcmitype/StillImage" /></cc:Work></rdf:RDF></metadata><defs
     id="defs6"><clipPath
       id="clipPath18"
       clipPathUnits="userSpaceOnUse"><path
         id="path16"
         d="M 0,288.511 H 432.512 V 0 H 0 Z" /></clipPath></defs><g
     transform="matrix(1.3333333,0,0,-1.3333333,0,384.68133)"
     id="g10"><g
       id="g12"><g
         clip-path="url(#clipPath18)"
         id="g14"><g
           transform="translate(36.2588,261.2549)"
           id="g20"><path
             id="path22"
             style="fill:none;stroke:#000000;stroke-width:0.5;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:2.61299992;stroke-dasharray:none;stroke-opacity:1"
             d="m 0,0 c 4.975,0 9.002,-4.028 9.002,-9.002 0,-4.975 -4.027,-9.002 -9.002,-9.002 -4.974,0 -9.002,4.027 -9.002,9.002 C -9.002,-4.028 -4.974,0 0,0 Z" /></g><g
           transform="translate(387.2622,252.2524)"
           id="g24"><path
             id="path26"
             style="fill:none;stroke:#000000;stroke-width:0.5;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:2.61299992;stroke-dasharray:none;stroke-opacity:1"
             d="m 0,0 c 0,4.974 4.028,9.002 9.002,9.002 4.975,0 9.003,-4.028 9.003,-9.002 0,-4.974 -4.028,-9.002 -9.003,-9.002 C 4.028,-9.002 0,-4.974 0,0 Z" /></g><g
           transform="translate(36.2588,45.249)"
           id="g28"><path
             id="path30"
             style="fill:none;stroke:#000000;stroke-width:0.5;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:2.61299992;stroke-dasharray:none;stroke-opacity:1"
             d="m 0,0 c 4.975,0 9.002,-4.028 9.002,-9.002 0,-4.975 -4.027,-9.003 -9.002,-9.003 -4.974,0 -9.002,4.028 -9.002,9.003 C -9.002,-4.028 -4.974,0 0,0 Z" /></g><g
           transform="translate(396.2529,45.249)"
           id="g32"><path
             id="path34"
             style="fill:none;stroke:#000000;stroke-width:0.5;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:2.61299992;stroke-dasharray:none;stroke-opacity:1"
             d="m 0,0 c 4.974,0 9.002,-4.028 9.002,-9.002 0,-4.975 -4.028,-9.003 -9.002,-9.003 -4.974,0 -9.002,4.028 -9.002,9.003 C -9.002,-4.028 -4.974,0 0,0 Z" /></g><g
           transform="translate(18.2544,0.25)"
           id="g36"><path
             id="path38"
             style="fill:none;stroke:#000000;stroke-width:0.5;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:2.61299992;stroke-dasharray:none;stroke-opacity:1"
             d="m 0,0 h 396.003 c 9.902,0 18.004,8.102 18.004,18.004 v 252.003 c 0,9.902 -8.102,18.004 -18.004,18.004 H 0 c -9.902,0 -18.004,-8.102 -18.004,-18.004 V 18.004 C -18.004,8.102 -9.902,0 0,0 Z" /></g></g></g></g></svg>`;
const svg_dwg = `<?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.0//EN" "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="body_545444514_72469" width="1600" height="1600">

<g transform="matrix(15.900040902177192 0 0 -15.900040902177192 2636.5962345654953 -647.22092791412297)" >
    <g>
                <path d="M-115.5089 -43.526000000000003L-90.534400000000005 -61.670999999999999L-65.559899999999999 -79.816100000000006L-75.099299999999999 -109.1754L-84.6387 -138.53469999999999L-115.5089 -138.53469999999999L-146.37909999999999 -138.53469999999999L-155.91849999999999 -109.1754L-165.4579 -79.816100000000006L-140.48339999999999 -61.670999999999999L-115.5089 -43.526000000000003L-115.5089 -43.526000000000003" stroke="#000000" stroke-width="0.034091106742198805" stroke-linecap="round" stroke-linejoin="round" fill="none" />
            <path d="M-115.5089 -91.15050001907349L-115.85035793318748 -91.162423809051518L-116.19015230073929 -91.198137958526615L-116.52662773265838 -91.257467468261723L-116.85814483299255 -91.340123851776127L-117.1830886138916 -91.445704658508305L-117.499875856781 -91.573694904327397L-117.80696327819824 -91.723471363067631L-118.10285480155945 -91.894304473876957L-118.38610870971679 -92.085361917495732L-118.65534527435302 -92.295712430953984L-118.90925271644592 -92.524331768035893L-119.14659388198852 -92.770105798721318L-119.36621267929077 -93.03183718490601L-119.56703884735107 -93.308250864028935L-119.74809439315796 -93.598000009536747L-119.90849669113159 -93.899673183441166L-120.04746515884399 -94.21180077362061L-120.1643217338562 -94.532861788749699L-120.25849754943847 -94.861292322158818L-120.32953388824463 -95.195492167949681L-120.3770845664978 -95.533833165645603L-120.40091784133911 -95.874666963696484L-120.40091784133911 -96.216333036303524L-120.3770845664978 -96.557166834354405L-120.32953388824463 -96.895507832050328L-120.25849754943847 -97.229707677841191L-120.1643217338562 -97.558138211250309L-120.04746515884399 -97.879199226379399L-119.90849669113159 -98.191326816558842L-119.74809439315796 -98.492999990463261L-119.56703884735107 -98.782749135971073L-119.36621267929077 -99.059162815093998L-119.14659388198852 -99.320894201278691L-118.90925271644592 -99.566668231964115L-118.65534527435302 -99.795287569046025L-118.38610870971679 -100.00563808250428L-118.10285480155945 -100.19669552612305L-117.80696327819824 -100.36752863693238L-117.499875856781 -100.51730509567261L-117.1830886138916 -100.6452953414917L-116.85814483299255 -100.75087614822388L-116.52662773265838 -100.83353253173829L-116.19015230073929 -100.89286204147339L-115.85035793318748 -100.92857619094849L-115.5089 -100.94049998092652L-115.16744206681251 -100.92857619094849L-114.82764769926071 -100.89286204147339L-114.49117226734161 -100.83353253173829L-114.15965516700744 -100.75087614822388L-113.8347113861084 -100.6452953414917L-113.51792414321899 -100.51730509567261L-113.21083672180175 -100.36752863693238L-112.91494519844055 -100.19669552612305L-112.6316912902832 -100.00563808250428L-112.36245472564697 -99.795287569046025L-112.10854728355407 -99.566668231964115L-111.87120611801147 -99.320894201278691L-111.65158732070923 -99.059162815093998L-111.45076115264892 -98.782749135971073L-111.26970560684204 -98.492999990463261L-111.10930330886841 -98.191326816558842L-110.970334841156 -97.879199226379399L-110.8534782661438 -97.558138211250309L-110.75930245056152 -97.229707677841191L-110.68826611175537 -96.895507832050328L-110.64071543350219 -96.557166834354405L-110.61688215866089 -96.216333036303524L-110.61688215866089 -95.874666963696484L-110.64071543350219 -95.533833165645603L-110.68826611175537 -95.195492167949681L-110.75930245056152 -94.861292322158818L-110.8534782661438 -94.532861788749699L-110.970334841156 -94.21180077362061L-111.10930330886841 -93.899673183441166L-111.26970560684204 -93.598000009536747L-111.45076115264892 -93.308250864028935L-111.65158732070923 -93.03183718490601L-111.87120611801147 -92.770105798721318L-112.10854728355407 -92.524331768035893L-112.36245472564697 -92.295712430953984L-112.6316912902832 -92.085361917495732L-112.91494519844055 -91.894304473876957L-113.21083672180175 -91.723471363067631L-113.51792414321899 -91.573694904327397L-113.8347113861084 -91.445704658508305L-114.15965516700744 -91.340123851776127L-114.49117226734161 -91.257467468261723L-114.82764769926071 -91.198137958526615L-115.5089 -91.15050001907349" stroke="#000000" stroke-width="0.034091106742198805" stroke-linecap="round" stroke-linejoin="round" fill="none" />
    </g>
</g>
</svg>`;
const svg_eps = `<?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.0//EN" "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="body_1092548773_73446" width="1600" height="1600">

<g transform="matrix(265.27247636797097 0 0 -265.27247636797097 -665.75643635931442 2866.4022937002565)" >
    <g>
                <path d="M3.0255000000000001 9.4147099999999995L3.0376500000000002 9.4147099999999995L3.0741700000000001 9.40489L3.1139299999999999 9.3781499999999998L3.1407400000000001 9.3383699999999994L3.15056 9.3018599999999996L3.15056 9.28965L3.15056 9.2774999999999999L3.1407400000000001 9.2409999999999997L3.1139299999999999 9.2012800000000006L3.0741700000000001 9.1744900000000005L3.0376500000000002 9.16465L3.0255000000000001 9.16465L3.01329 9.16465L2.9767800000000002 9.1744900000000005L2.9370699999999998 9.2012800000000006L2.9102600000000001 9.2409999999999997L2.9005000000000001 9.2774999999999999L2.9005000000000001 9.28965L2.9005000000000001 9.3018599999999996L2.9102600000000001 9.3383699999999994L2.9370699999999998 9.3781499999999998L2.9767800000000002 9.40489L3.01329 9.4147099999999995L3.0255000000000001 9.4147099999999995L3.0255000000000001 9.4147099999999995" stroke="#000000" stroke-width="0.50002998113632202" stroke-linejoin="round" fill="none" />
                <path d="M7.9005599999999996 9.28965L7.9005599999999996 9.3018599999999996L7.91038 9.3383699999999994L7.9371299999999998 9.3781499999999998L7.97689 9.40489L8.0134000000000007 9.4147099999999995L8.0256100000000004 9.4147099999999995L8.0377600000000005 9.4147099999999995L8.0742799999999999 9.40489L8.1139899999999994 9.3781499999999998L8.1407900000000009 9.3383699999999994L8.1506100000000004 9.3018599999999996L8.1506100000000004 9.28965L8.1506100000000004 9.2774999999999999L8.1407900000000009 9.2409999999999997L8.1139899999999994 9.2012800000000006L8.0742799999999999 9.1744900000000005L8.0377600000000005 9.16465L8.0256100000000004 9.16465L8.0134000000000007 9.16465L7.97689 9.1744900000000005L7.9371299999999998 9.2012800000000006L7.91038 9.2409999999999997L7.9005599999999996 9.2774999999999999L7.9005599999999996 9.28965L7.9005599999999996 9.28965" stroke="#000000" stroke-width="0.50002998113632202" stroke-linejoin="round" fill="none" />
                <path d="M3.0255000000000001 6.4146099999999997L3.0376500000000002 6.4146099999999997L3.0741700000000001 6.4048299999999996L3.1139299999999999 6.3780400000000004L3.1407400000000001 6.3383200000000004L3.15056 6.3018099999999997L3.15056 6.2896099999999997L3.15056 6.2774599999999996L3.1407400000000001 6.2409400000000002L3.1139299999999999 6.2011700000000003L3.0741700000000001 6.1743699999999997L3.0376500000000002 6.1645599999999998L3.0255000000000001 6.1645599999999998L3.01329 6.1645599999999998L2.9767800000000002 6.1743699999999997L2.9370699999999998 6.2011700000000003L2.9102600000000001 6.2409400000000002L2.9005000000000001 6.2774599999999996L2.9005000000000001 6.2896099999999997L2.9005000000000001 6.3018099999999997L2.9102600000000001 6.3383200000000004L2.9370699999999998 6.3780400000000004L2.9767800000000002 6.4048299999999996L3.01329 6.4146099999999997L3.0255000000000001 6.4146099999999997L3.0255000000000001 6.4146099999999997" stroke="#000000" stroke-width="0.50002998113632202" stroke-linejoin="round" fill="none" />
                <path d="M8.0254399999999997 6.4146099999999997L8.0375999999999994 6.4146099999999997L8.0741099999999992 6.4048299999999996L8.1138200000000005 6.3780400000000004L8.1406299999999998 6.3383200000000004L8.1504399999999997 6.3018099999999997L8.1504399999999997 6.2896099999999997L8.1504399999999997 6.2774599999999996L8.1406299999999998 6.2409400000000002L8.1138200000000005 6.2011700000000003L8.0741099999999992 6.1743699999999997L8.0375999999999994 6.1645599999999998L8.0254399999999997 6.1645599999999998L8.0132399999999997 6.1645599999999998L7.9767200000000003 6.1743699999999997L7.93696 6.2011700000000003L7.9102100000000002 6.2409400000000002L7.9003899999999998 6.2774599999999996L7.9003899999999998 6.2896099999999997L7.9003899999999998 6.3018099999999997L7.9102100000000002 6.3383200000000004L7.93696 6.3780400000000004L7.9767200000000003 6.4048299999999996L8.0132399999999997 6.4146099999999997L8.0254399999999997 6.4146099999999997L8.0254399999999997 6.4146099999999997" stroke="#000000" stroke-width="0.50002998113632202" stroke-linejoin="round" fill="none" />
                <path d="M2.7754400000000001 5.78965L8.2754999999999992 5.78965L8.2997499999999995 5.78965L8.37256 5.8094000000000001L8.4520999999999997 5.8631200000000003L8.5058100000000003 5.9426500000000004L8.5255600000000005 6.01546L8.5255600000000005 6.0397100000000004L8.5255600000000005 9.5397099999999995L8.5255600000000005 9.5640099999999997L8.5058100000000003 9.6368299999999998L8.4520999999999997 9.7163599999999999L8.37256 9.7701200000000004L8.2997499999999995 9.7898200000000006L8.2754999999999992 9.7898200000000006L2.7754400000000001 9.7898200000000006L2.7511399999999999 9.7898200000000006L2.6783299999999999 9.7701200000000004L2.5987900000000002 9.7163599999999999L2.54508 9.6368299999999998L2.5253899999999998 9.5640099999999997L2.5253899999999998 9.5397099999999995L2.5253899999999998 6.0397100000000004L2.5253899999999998 6.01546L2.54508 5.9426500000000004L2.5987900000000002 5.8631200000000003L2.6783299999999999 5.8094000000000001L2.7511399999999999 5.78965L2.7754400000000001 5.78965L2.7754400000000001 5.78965" stroke="#000000" stroke-width="0.50002998113632202" stroke-linejoin="round" fill="none" />
    </g>
</g>
</svg>`;
const vite_svg = `<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="31.88" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 257"><defs><linearGradient id="IconifyId1813088fe1fbc01fb466" x1="-.828%" x2="57.636%" y1="7.652%" y2="78.411%"><stop offset="0%" stop-color="#41D1FF"></stop><stop offset="100%" stop-color="#BD34FE"></stop></linearGradient><linearGradient id="IconifyId1813088fe1fbc01fb467" x1="43.376%" x2="50.316%" y1="2.242%" y2="89.03%"><stop offset="0%" stop-color="#FFEA83"></stop><stop offset="8.333%" stop-color="#FFDD35"></stop><stop offset="100%" stop-color="#FFA800"></stop></linearGradient></defs><path fill="url(#IconifyId1813088fe1fbc01fb466)" d="M255.153 37.938L134.897 252.976c-2.483 4.44-8.862 4.466-11.382.048L.875 37.958c-2.746-4.814 1.371-10.646 6.827-9.67l120.385 21.517a6.537 6.537 0 0 0 2.322-.004l117.867-21.483c5.438-.991 9.574 4.796 6.877 9.62Z"></path><path fill="url(#IconifyId1813088fe1fbc01fb467)" d="M185.432.063L96.44 17.501a3.268 3.268 0 0 0-2.634 3.014l-5.474 92.456a3.268 3.268 0 0 0 3.997 3.378l24.777-5.718c2.318-.535 4.413 1.507 3.936 3.838l-7.361 36.047c-.495 2.426 1.782 4.5 4.151 3.78l15.304-4.649c2.372-.72 4.652 1.36 4.15 3.788l-11.698 56.621c-.732 3.542 3.979 5.473 5.943 2.437l1.313-2.028l72.516-144.72c1.215-2.423-.88-5.186-3.54-4.672l-25.505 4.922c-2.396.462-4.435-1.77-3.759-4.114l16.646-57.705c.677-2.35-1.37-4.583-3.769-4.113Z"></path></svg>`;
const svg = svg_ai;
// main.js
const defaultExtrusion = 1;
const app = document.querySelector('#app');
const extrusionInput = document.querySelector('#input');
const scene = setupScene(app);
const { object, update } = renderSVG(defaultExtrusion, svg);
// const { object: object2, update: update2 } = renderSVG(2, vite_svg);

console.log(object);
scene.add(object);
// scene.add(object2);

extrusionInput.addEventListener('input', () => {
  update(Number(extrusionInput.value));
});
extrusionInput.value = defaultExtrusion;
